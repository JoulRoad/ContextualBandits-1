<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LinUCB Simulation</title>
    <script src="lib/math.js"></script>
    <script src="lib/d3.v5.min.js"></script>
    <script src="lib/d3-random.v2.min.js"></script>
    <script src="js/charts.min.js"></script>
    <script src="build/js/contextualbandits.min.js"></script>

    <script src="js/generatedata.js"></script>
    <script src="js/simulation.js"></script>
</head>

<body>
<b>True theta</b> (the linear coefficients link between reward and features)
<div style="width: 600px; height: 400px;" id="theta"></div>
<br/><br/>
<b>Regrets</b> (comparing random policy and LinUCB with different alphas)
<div style="width: 600px; height: 400px;" id="regrets"></div>
<script>
    let trials = Array.from(new Array(N_TRIALS), (_, i) => i);
    let heatMapData = {
        x: Array.from(new Array(N_ARMS), (_, i) => i),
        y: Array.from(new Array(N_FEATURES), (_, i) => i),
        z: trueTheta
    };
    let heatMapSettings = {
        noSvg: false,
        showAxes: true,
        paddingLeft: 60,
        paddingRight: 50,
        paddingTop: 20,
        paddingBottom: 45,
        showColorBar: true,
        xAxisLabel: {text: 'arms'},
        yAxisLabel: {text: 'features'}
    };
    let hm = new HeatMap(document.getElementById("theta"), heatMapData, heatMapSettings);
    hm.plot();


    let oracles = X.map(trial => {
        //Generate array of scores => then sort ascending => then take the last N_ARMS (largest)
        return math.sum((trial.map((arm, i) => {
            return math.dot(arm, trueTheta[i]);
        })).sort((a, b) => a - b).slice(-N_ARMS_TO_RECOMMEND));
    });

    let payoffsRandom = X.map(trial => {
        let totalRewards = 0;
        for (let i = 0; i < N_ARMS_TO_RECOMMEND; i++) {
            //Select one random arm
            let randomArm = d3.randomInt(0, N_ARMS)();
            //Add the score
            totalRewards += math.dot(trial[randomArm], trueTheta[randomArm]);
        }
        return totalRewards;
    });

    let regretsRandom = makeRegret(payoffsRandom, oracles);
    let regrets = {};
    regrets['random'] = regretsRandom;

    let alphas = [0, 1.0, 2.5, 5.0, 10.0];
    alphas.forEach(alpha => {
        let payoffsAlpha = linUCB(alpha, X, generateReward, trueTheta, N_ARMS_TO_RECOMMEND);
        regrets['alpha=' + alpha] = makeRegret(payoffsAlpha, oracles);
    });

    let lineChartData = Object.keys(regrets).map(k => {
        return {
            x: trials,
            y: regrets[k],
            series: k
        }
    });
    let lcSettings = {
        noSvg: false,
        showAxes: true,
        paddingLeft: 60,
        paddingRight: 30,
        paddingTop: 20,
        paddingBottom: 45,
        legend: {
            x: 60 + 20,
            y: 20 + 20
        },
        xAxisLabel: {text: 'trials'},
        yAxisLabel: {text: 'cumulative regrets'}
    };
    //Change color scheme to category 10
    lcSettings.colorScale = d3.scaleOrdinal()
        .domain(lineChartData.map(ld => ld.series))
        .range(lineChartData.map((_, i) => {
            return d3.schemeCategory10[i];
        }));

    let lc = new LineChart(document.getElementById('regrets'),
        lineChartData, lcSettings);
    lc.plot();
</script>
</body>
</html>
